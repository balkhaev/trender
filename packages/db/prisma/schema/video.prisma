model VideoAnalysis {
  id           String   @id @default(uuid())
  sourceType   String // "upload", "reel", "url"
  sourceId     String? // reelId if from reel
  fileName     String?
  analysisType String @default("standard") // "standard" | "frames" | "scenes"

  // Core fields
  duration     Int?   // Длительность в секундах
  aspectRatio  String @default("9:16") // Соотношение сторон

  // Smart Remix Elements - main data
  elements     Json @default("[]") // [{id, type, label, description, remixOptions}]

  // Scene-based analysis
  hasScenes    Boolean @default(false) // Флаг: есть ли разбиение на сцены
  scenesCount  Int?                     // Количество сцен

  // Legacy fields (kept for old analyses, optional now)
  subject      String @default("")
  action       String @default("")
  environment  String @default("")
  cameraStyle  String @default("")
  mood         String @default("")
  colorPalette String @default("")
  style        String @default("")
  lighting     String @default("")
  pacing       String @default("")
  cameraWork   String @default("")

  // Legacy detailed fields
  scenes           Json @default("[]")
  characters       Json @default("[]")
  objects          Json @default("[]")
  cameraMovements  Json @default("[]")
  transitions      Json @default("[]")
  audio            Json @default("{}")
  textOverlays     Json @default("[]")

  // Legacy prompts
  klingPrompt  String @default("")
  veo3Prompt   String @default("")

  tags         String[] @default([])
  suggestions  Json @default("[]")

  createdAt DateTime @default(now())

  // Relations
  generations VideoGeneration[]
  template    Template?
  videoScenes VideoScene[]
  compositeGenerations CompositeGeneration[]
  generationConfigs GenerationConfig[]

  @@index([sourceType])
  @@index([sourceId])
  @@index([sourceId, analysisType])
  @@index([createdAt])
}

model VideoGeneration {
  id         String        @id @default(uuid())
  jobId      String?       @unique  // BullMQ job ID для связи с очередью
  analysisId String
  analysis   VideoAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Связь с конфигурацией (если создано через Simple/Expert mode)
  configId   String?
  config     GenerationConfig? @relation(fields: [configId], references: [id], onDelete: SetNull)

  provider String // "kling" (video-to-video)
  status   String @default("pending") // pending, processing, completed, failed
  prompt   String // Промпт изменений для Kling

  // Source video for video-to-video generation
  sourceVideoUrl String? // URL исходного видео для референса
  sourceVideoS3Key String? // S3 ключ исходного видео

  // Generation options
  outputDuration Int @default(5) // 5 или 10 секунд
  outputAspectRatio String @default("auto") // "16:9" | "9:16" | "1:1" | "auto"
  keepAudio Boolean @default(false)

  // Remix feature: image references
  imageReferences String[] @default([]) // URLs загруженных изображений для @Image/@Element
  remixSource     String?  // ID оригинального рила-источника для remix

  // Result
  videoUrl     String?
  s3Key        String?     // ключ файла в S3/MinIO
  thumbnailUrl String?
  durationSec  Int?
  error        String?

  // Kling API specific
  klingTaskId  String? // ID задачи в Kling API

  // Progress tracking
  progress        Int       @default(0)      // 0-100%
  progressStage   String    @default("pending") // "pending" | "processing" | "downloading" | "uploading"
  progressMessage String    @default("")     // Человекочитаемое сообщение
  klingProgress   Int?                       // Прогресс от Kling API (если есть)
  lastActivityAt  DateTime?                  // Время последней активности

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([analysisId])
  @@index([status])
  @@index([klingTaskId])
  @@index([remixSource])
  @@index([configId])
}

// Scene in a video (detected by PySceneDetect)
model VideoScene {
  id           String   @id @default(uuid())
  analysisId   String
  analysis     VideoAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Scene position
  index        Int              // Sequential number (0, 1, 2...)
  startTime    Float            // Start time in seconds
  endTime      Float            // End time in seconds
  duration     Float            // Duration in seconds

  // Preview
  thumbnailUrl    String?       // URL of scene thumbnail
  thumbnailS3Key  String?       // S3 key of thumbnail

  // Elements detected in this scene
  elements     Json @default("[]")  // [{id, type, label, description, remixOptions}]

  // Generation status for this scene
  generationStatus String @default("none")  // "none" | "pending" | "processing" | "completed" | "original"

  createdAt    DateTime @default(now())

  // Relations
  generations  SceneGeneration[]

  @@unique([analysisId, index])
  @@index([analysisId])
  @@index([generationStatus])
}

// Generation for a specific scene
model SceneGeneration {
  id           String   @id @default(uuid())
  sceneId      String
  scene        VideoScene @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  // BullMQ link
  jobId        String?  @unique

  // Selected elements and options for remix
  selectedElements Json @default("[]")  // [{elementId, selectedOptionId, prompt}]
  prompt       String              // Full prompt for Kling

  // Kling API
  provider     String @default("kling")
  status       String @default("pending")  // pending, processing, completed, failed
  klingTaskId  String?

  // Result
  videoUrl     String?
  s3Key        String?
  error        String?

  // Progress
  progress        Int       @default(0)      // 0-100%
  progressStage   String    @default("pending") // "pending" | "trimming" | "generating" | "downloading" | "uploading"
  progressMessage String    @default("")
  lastActivityAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  completedAt  DateTime?

  @@index([sceneId])
  @@index([status])
  @@index([klingTaskId])
}

// Composite generation (concatenation of all scenes)
model CompositeGeneration {
  id           String   @id @default(uuid())
  analysisId   String
  analysis     VideoAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // BullMQ link
  jobId        String?  @unique

  // Configuration: which scenes to use
  sceneConfig  Json @default("[]")  // [{sceneId, sceneIndex, useOriginal: boolean, generationId?: string}]

  // Status
  status       String @default("pending")  // pending, waiting, generating, concatenating, uploading, completed, failed

  // Result
  videoUrl     String?
  s3Key        String?
  error        String?

  // Progress
  progress        Int       @default(0)      // 0-100%
  progressStage   String    @default("pending") // "pending" | "waiting" | "concatenating" | "uploading" | "completed"
  progressMessage String    @default("")
  lastActivityAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  completedAt  DateTime?

  @@index([analysisId])
  @@index([status])
}
